define(["Libras","../../core/FieldUtils","../../core/GeoUtils"],function(e,t,n){var i=e.Cartesian2,a=e.ScreenSpaceEventHandler,o=e.defined,p=e.ScreenSpaceEventType,s=e.DeveloperError;function r(e){this.viewer=e.viewer,this.scene=this.viewer.scene,this.title=e.title,this.content=e.content,this.actions=e.actions,this.id=e.id,this.popStart()}return r.prototype.popStart=function(){var e=this;if(!o(this.viewer))throw new s("viewer is required");var t=this.scene;new a(t.canvas).setInputAction(function(n){var i=t.pick(n.position),a=t.globe.pick(e.viewer.camera.getPickRay(n.position),t);!o(i)||!i.id||i.id instanceof Array?e.closePop():i.id.popupEnabled&&(e.createPopElements(),i.id.model&&i.id.position&&(a=t.pickPosition(n.position)),(i.id.billboard||i.id.label||i.id.point)&&i.id.position&&(a=i.id.position._value),e.popOut(a,i.id),i.id.popupTemplate&&(e.actions=i.id.popupTemplate.actions),setTimeout(function(){e.scene.requestRenderMode=!0},500))},p.LEFT_CLICK)},r.prototype.popOut=function(t,a){var p=this,s=new i,r=a.popupTemplate;if(!r)return document.getElementById("trackPopUp").style.display="none",void(document.getElementById("dockPopUp").style.display="none");var l=document.getElementsByClassName("libras-popup")[0],c=document.getElementsByClassName("libras-popup-header-title")[0],d=document.getElementsByClassName("libras-popup-content")[0],m=document.getElementById("trackPopUp"),u=document.getElementById("dockPopUp");c.innerHTML=r.title&&this.writeContent(a,"title"),d.innerHTML=r.content&&this.writeContent(a,"content");var v=n.cartesian2Degrees(t),b=v.longitude,h=v.latitude,y=document.querySelector(".libras-popup"),g=new e.Cartesian2(y.offsetLeft,0),E=p.viewer.scene.globe.pick(p.viewer.camera.getPickRay(g),p.viewer.scene),f=E&&n.cartesian2Degrees(E),C=f?f.latitude:0,N=new e.Cartesian2(y.offsetLeft+y.clientWidth/2,y.offsetTop+y.clientHeight/2),k=p.viewer.scene.globe.pick(p.viewer.camera.getPickRay(N),p.viewer.scene),T=k&&n.cartesian2Degrees(k),w=T?T.latitude:0;p.viewer.camera.flyTo({destination:e.Cartesian3.fromDegrees(b,h+Math.abs(C-w),p.viewer.camera.positionCartographic.height)}),u&&(m.style.display="none",u.getElementsByClassName("libras-popup-header-title")[0].innerHTML=r.title&&this.writeContent(a,"title"),u.getElementsByClassName("libras-popup-content")[0].innerHTML=r.title&&this.writeContent(a,"content")),p.scene.postRender.addEventListener(function(){var e=p.scene.cartesianToCanvasCoordinates(t,s);o(e)&&(m.style.top=e.y-l.clientHeight-20+"px",m.style.left=e.x-m.children[0].offsetWidth/2+"px")}),a.popupTemplate&&p.renderActions(a.popupTemplate.actions),p.scene.requestRenderMode=!1},r.prototype.closePop=function(){var e=document.getElementById("trackPopUp"),t=document.getElementById("dockPopUp");if(e||t){var n=document.getElementsByClassName("libras-popup-header-title")[0],i=document.getElementsByClassName("libras-popup-content")[0];n.innerHTML="",i.innerHTML="",e.style.display="none",t&&self.viewer.container.removeChild(t),t&&(document.getElementsByClassName("libras-popup-button")[0].innerHTML='<span class="libras-icon-dock-right"></span>'),document.getElementsByClassName("libras-popup-button")[0].setAttribute("title","停靠"),document.getElementsByClassName("libras-popup-button")[0].setAttribute("aria-label","停靠")}},r.prototype.dockPop=function(e){var t=this,n=document.getElementById("trackPopUp");if(e&&"libras-icon-dock-right"===e.srcElement.className){document.getElementsByClassName("libras-popup-button")[0].innerHTML='<span class="libras-icon-minimize"></span>',n.style.display="none";var i=document.createElement("div");i.id="dockPopUp",i.appendChild(n.childNodes[0].cloneNode()),i.appendChild(n.childNodes[0].childNodes[0].cloneNode(!0));var a=i.getElementsByClassName("libras-popup-button")[0],o=i.getElementsByClassName("libras-popup-button")[1];a.setAttribute("title","未停靠"),a.setAttribute("aria-label","未停靠"),a.onclick=function(e){t.dockPop(e)},o.onclick=function(){t.closePop()},t.viewer.container.appendChild(i),t.renderActions(t.actions)}else e&&"libras-icon-minimize"===e.srcElement.className&&(document.getElementsByClassName("libras-popup-button")[0].innerHTML='<span class="libras-icon-dock-right"></span>',document.getElementsByClassName("libras-popup-button")[0].setAttribute("title","停靠"),document.getElementsByClassName("libras-popup-button")[0].setAttribute("aria-label","停靠"),t.viewer.container.removeChild(document.getElementById("dockPopUp")),n.style.display="block")},r.prototype.createPopElements=function(){var e=this;if(document.getElementById("trackPopUp"))document.getElementById("trackPopUp").style.display="";else{var t=document.createElement("div");t.id="trackPopUp";var n=document.createElement("div");n.className="libras-popup";var i=document.createElement("div");i.className="libras-popup-content-wrapper";var a=document.createElement("div");a.className="libras-popup-header-buttons";var o=document.createElement("div");o.className="libras-popup-button",o.setAttribute("title","停靠"),o.setAttribute("aria-label","停靠");var p=document.createElement("span");p.className="libras-icon-dock-right",o.appendChild(p),o.onclick=function(t){e.dockPop(t)};var s=document.createElement("div");s.className="libras-popup-button",s.setAttribute("title","关闭"),s.setAttribute("aria-label","关闭");var r=document.createElement("span");r.className="libras-icon-close",s.appendChild(r);var l=document.createElement("h2");l.className="libras-popup-header-title",a.appendChild(l),a.appendChild(o),a.appendChild(s);var c=document.createElement("div");c.className="libras-popup-content";var d=document.createElement("div");d.className="libras-popup-footer",i.appendChild(a),i.appendChild(c),i.appendChild(d);var m=document.createElement("div");m.className="libras-popup-tip-container";var u=document.createElement("div");u.className="libras-popup-tip",m.appendChild(u),n.appendChild(i),n.appendChild(m),s.onclick=function(){e.closePop()},t.appendChild(n),e.viewer.container.appendChild(t)}},r.prototype.renderActions=function(e){var t=document.getElementById("trackPopUp"),n=document.getElementById("dockPopUp"),i=t&&t.getElementsByClassName("libras-popup-footer")[0],a=n&&n.getElementsByClassName("libras-popup-footer")[0];if(i&&(i.innerHTML=""),a&&(a.innerHTML=""),e instanceof Array&&e.length>0){var o=e.map(l),p=e.map(l);for(var s in o)i&&i.appendChild(o[s]);for(var r in p)a&&a.appendChild(p[r])}function l(e){var t=document.createElement("div");t.className="libras-popup-button",t.setAttribute("title",e.title),t.setAttribute("aria-label",e.title);var n=document.createElement("span");return e.className&&n.setAttribute("class",e.className),e.image&&(n.style.backgroundImage="url("+e.image+")"),e.image&&n.setAttribute("class","libras-popup-footer-action-image"),t.appendChild(n),e.event&&(t.onclick=e.event),t}},r.prototype.writeContent=function(e,n){var i=t.Trim(e.popupTemplate[n],"g"),a=t.extractFieldNames(i);let o="";if(1===a.length&&"*"===a[0]&&3===t.Trim(e.popupTemplate[n],"g").length){var p=e.properties;for(var n in o+="<table>",p._propertyNames)o+="<tr><th>"+p._propertyNames[n]+`</th><td>${p[p._propertyNames[n]]}</td></tr>`;o+="</table>"}else if(a.length>=1){p=e.properties;for(var s=e.popupTemplate[n].split(/\{[^}]*\}/),r=0;r<s.length;r++)r===s.length-1||"*"===a[r]?o+=s[r]:o+=s[r]+`${p[a[r]]}`}else o=e.popupTemplate[n];return o},r.prototype.autoPopOut=function(e){var t=this,n=this.viewer.entities.values;for(let a in n)if(n[a].popupTemplate&&n[a].popupTemplate.title&&(n[a].popupTemplate.title===e||n[a].popupTemplate.id===e)){var i=n[a].position._value;return i&&t.createPopElements(),t.popOut(i,n[a]),void setTimeout(function(){t.scene.requestRenderMode=!0},500)}},r});