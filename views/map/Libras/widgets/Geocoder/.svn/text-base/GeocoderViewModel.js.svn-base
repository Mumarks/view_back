define(["Libras","../../search/Query"],function(e,t){"use strict";var s=e.BingMapsGeocoderService,n=e.CartographicGeocoderService,i=e.defaultValue,o=e.defined,r=e.defineProperties,c=e.DeveloperError,u=e.Event,g=e.Matrix4,a=e.knockout,h=e.when,l=(e.GeoJsonDataSource,e.createCommand),d=e.getElement;function f(e){if(!o(e)||!o(e.scene))throw new c("options.scene is required.");o(e.geocoderServices)?this._geocoderServices=e.geocoderServices:this._geocoderServices=[new n,new s({scene:e.scene})],this._viewContainer=e.container,this._scene=e.scene,this._flightDuration=e.flightDuration,this._searchText="",this._isSearchInProgress=!1,this._geocodePromise=void 0,this._complete=new u,this._suggestions=[],this._selectedSuggestion=void 0,this._showSuggestions=!0,this._updateCamera=S,this._adjustSuggestionsScroll=m,this._updateSearchSuggestions=x,this._handleArrowDown=v,this._handleArrowUp=_;var t=this;this._suggestionsVisible=a.pureComputed(function(){var e=a.getObservable(t,"_suggestions")().length>0,s=a.getObservable(t,"_showSuggestions")();return e&&s}),this._searchCommand=l(function(){if(t._focusTextbox=!1,o(t._selectedSuggestion))return t.activateSuggestion(t._selectedSuggestion),!1;var e;t.hideSuggestions(),t.isSearchInProgress?((e=t)._isSearchInProgress=!1,o(e._geocodePromise)&&(e._geocodePromise.cancel=!0,e._geocodePromise=void 0)):function(e,t){var s=e._searchText;if(w(s))return void e.showSuggestions();e._isSearchInProgress=!0;for(var n=h.resolve(),i=0;i<t.length;i++)n=p(n,t[i],s);e._geocodePromise=n,n.then(function(t){if(!n.cancel){e._isSearchInProgress=!1;var i=t.value;if("fulfilled"===t.state&&o(i)&&i.length>0)return e._searchText=i[0].displayName,void S(e,i[0].destination);e._searchText=s+" (not found)"}})}(t,t._geocoderServices)}),this.deselectSuggestion=function(){t._selectedSuggestion=void 0},this.handleKeyDown=function(e,t){var s="ArrowDown"===t.key||"Down"===t.key||40===t.keyCode,n="ArrowUp"===t.key||"Up"===t.key||38===t.keyCode;return(s||n)&&t.preventDefault(),!0},this.handleKeyUp=function(e,s){var n="ArrowDown"===s.key||"Down"===s.key||40===s.keyCode,i="ArrowUp"===s.key||"Up"===s.key||38===s.keyCode,o="Enter"===s.key||13===s.keyCode;return i?_(t):n?v(t):o&&t._searchCommand(),!0},this.activateSuggestion=function(e){t.hideSuggestions(),t._searchText=e.displayName;var s=e.destination;y(t),S(t,s)},this.hideSuggestions=function(){t._showSuggestions=!1,t._selectedSuggestion=void 0},this.showSuggestions=function(){t._showSuggestions=!0},this.handleMouseover=function(e,s){e!==t._selectedSuggestion&&(t._selectedSuggestion=e)},this.keepExpanded=!1,this.autoComplete=i(e.autocomplete,!0),this._focusTextbox=!1,a.track(this,["_searchText","_isSearchInProgress","keepExpanded","_suggestions","_selectedSuggestion","_showSuggestions","_focusTextbox"]);var r=a.getObservable(this,"_searchText");r.extend({rateLimit:{timeout:500}}),this._suggestionSubscription=r.subscribe(function(){x(t)}),this.isSearchInProgress=void 0,a.defineProperty(this,"isSearchInProgress",{get:function(){return this._isSearchInProgress}}),this.searchText=void 0,a.defineProperty(this,"searchText",{get:function(){return this.isSearchInProgress?"Searching...":this._searchText},set:function(e){if("string"!=typeof e)throw new c("value must be a valid string.");this._searchText=e}}),this.flightDuration=void 0,a.defineProperty(this,"flightDuration",{get:function(){return this._flightDuration},set:function(e){if(o(e)&&e<0)throw new c("value must be positive.");this._flightDuration=e}})}function _(e){if(0!==e._suggestions.length){var t,s=e._suggestions.indexOf(e._selectedSuggestion);-1!==s&&0!==s?(t=s-1,e._selectedSuggestion=e._suggestions[t],m(e,t)):e._selectedSuggestion=void 0}}function v(e){if(0!==e._suggestions.length){var t=e._suggestions.length,s=(e._suggestions.indexOf(e._selectedSuggestion)+1)%t;e._selectedSuggestion=e._suggestions[s],m(e,s)}}function S(t,s){s instanceof e.Cartesian3&&(s.z=1.01*s.z),t._scene.camera.flyTo({destination:s,complete:function(){t._complete.raiseEvent()},duration:t._flightDuration,endTransform:g.IDENTITY})}function p(e,t,s){return e.then(function(e){return o(e)&&"fulfilled"===e.state&&e.value.length>0?e:t.geocode(s).then(function(e){return{state:"fulfilled",value:e}}).otherwise(function(e){return{state:"rejected",reason:e}})})}function m(e,t){var s=d(e._viewContainer),n=s.getElementsByClassName("search-results")[0],i=s.getElementsByTagName("li")[t];if(0!==t){var o=i.offsetTop;o+i.clientHeight>n.clientHeight?n.scrollTop=o+i.clientHeight:o<n.scrollTop&&(n.scrollTop=o)}else n.scrollTop=0}function w(e){return/^\s*$/.test(e)}function y(e){a.getObservable(e,"_suggestions").removeAll()}function x(i){if(i.autoComplete){var o=i._searchText;if(y(i),!w(o)){var r=h.resolve([]);i._geocoderServices.forEach(function(e){if(e instanceof n||e instanceof s)r=r.then(function(t){return t.length>=5?t:e.geocode(o).then(function(e){return t=t.concat(e)})});else{var i=new t({where:e.options.keyWord+" like '%"+o+"%'"}),c=e.execute(i);r=r.then(function(e){return e.length>=5?e:c.then(function(t){return e=e.concat(t.entities.values)})})}}),r.then(function(t){for(var s=i._suggestions,n=0;n<t.length;n++)t[n]instanceof e.Entity&&(t[n].displayName=t[n].name,t[n].destination=t[n].position._value),s.push(t[n])})}}}return r(f.prototype,{complete:{get:function(){return this._complete}},scene:{get:function(){return this._scene}},search:{get:function(){return this._searchCommand}},selectedSuggestion:{get:function(){return this._selectedSuggestion}},suggestions:{get:function(){return this._suggestions}}}),f.prototype.destroy=function(){this._suggestionSubscription.dispose()},f});