define(["Libras"],function(e){function t(t){if(!e.defined(t.viewer))throw new e.RuntimeError("viewer is required");this.viewer=t.viewer,this.PolygonPointArray_fill=null,this.firstPointLon=-999,this.firstPointLat=-999,this.firstPointHei=-999,this.lastPointLon=-999,this.lastPointLat=-999,this.lastPointHei=-999,this.tempDataSource=null,this.targetDataSource=null,this.poinsTemp=[],this.isStartDraw=!1}return t.prototype.start=function(t){var o,i=this,n=i.viewer,r=n.scene,a=new e.Cartesian2;i.poinsTemp=[];var l=this.handlerPolygon=new e.ScreenSpaceEventHandler(n.scene.canvas),s=n.entities.add(new e.Entity),p=n.entities.add(new e.Entity);n.dataSources.add(new e.GeoJsonDataSource("tempDataSource")).then(function(e){i.tempDataSource=e}).otherwise(function(e){}),n.dataSources.add(new e.GeoJsonDataSource("targetDataSource")).then(function(e){i.targetDataSource=e}).otherwise(function(e){}),l.setInputAction(function(t){var a=n.camera.pickEllipsoid(t.position,r.globe.ellipsoid);if(a){var l=r.pickPosition(t.position),c=e.Cartographic.fromCartesian(l),y=e.Math.toDegrees(c.longitude),g=e.Math.toDegrees(c.latitude),h=c.height;i.isStartDraw?(i.tempDataSource.entities.add({position:a,clampToGround:!0,attachPolygon:!0,point:{parent:s,pixelSize:3,color:e.Color.YELLOW,disableDepthTestDistance:1e9}}),i.tempDataSource.entities.add({name:"line on the surface",parent:p,clampToGround:!0,attachPolygon:!0,polyline:{positions:e.Cartesian3.fromDegreesArrayHeights([i.lastPointLon,i.lastPointLat,i.lastPointHei,y,g,h]),width:2,material:e.Color.BLUE,clampToGround:!0,attachPolygon:!0,disableDepthTestDistance:1e9}}),h=o):(i.tempDataSource.entities.add({position:a,clampToGround:!0,attachPolygon:!0,point:{parent:s,pixelSize:3,color:e.Color.YELLOW,disableDepthTestDistance:1e9}}),i.firstPointLon=y,i.firstPointLat=g,i.firstPointHei=h,i.PolygonPointArray_fill=null,i.isStartDraw=!0,o=h),i.lastPointLon=y,i.lastPointLat=g,i.lastPointHei=h,null==i.PolygonPointArray_fill&&(i.PolygonPointArray_fill=new Array),i.PolygonPointArray_fill.push(y),i.PolygonPointArray_fill.push(g),i.PolygonPointArray_fill.push(h);var u=n.scene.pickPosition(t.position);i.poinsTemp.push(u)}n.scene.requestRender()},e.ScreenSpaceEventType.LEFT_CLICK),l.setInputAction(function(a){if(n.camera.pickEllipsoid(a.position,r.globe.ellipsoid)&&i.isStartDraw){var s=r.pickPosition(a.position),p=e.Cartographic.fromCartesian(s),c=e.Math.toDegrees(p.longitude),y=e.Math.toDegrees(p.latitude),g=o;null!=i.PolygonPointArray_fill&&(i.PolygonPointArray_fill.push(c),i.PolygonPointArray_fill.push(y),i.PolygonPointArray_fill.push(g)),i.poinsTemp.push(s),i.addPolygon()&&(t(),l.destroy(),console.log(i.PolygonPointArray_fill),i.PolygonPointArray_fill=null,i.isStartDraw=!1,i.polygonObj=new e.PolygonGeometry({polygonHierarchy:new e.PolygonHierarchy(i.poinsTemp),perPositionHeight:!0}),console.log(new e.PolygonGeometry({polygonHierarchy:new e.PolygonHierarchy(i.poinsTemp),perPositionHeight:!0})),document.getElementById("trackLabel")&&(document.getElementById("trackLabel").style.display="none"))}else i.PolygonPointArray_fill=null,i.tempDataSource.entities.removeAll(),i.targetDataSource.entities.removeAll()},e.ScreenSpaceEventType.RIGHT_CLICK),i.createLabel(),l.setInputAction(function(t){var o=n.camera.pickEllipsoid(t.endPosition,r.globe.ellipsoid),i=document.getElementById("trackLabel");if(i.style.display="block",o){e.Cartographic.fromCartesian(o);var l=r.cartesianToCanvasCoordinates(o,a);e.defined(l)&&(i.style.top=l.y-i.clientHeight+5+"px",i.style.left=l.x+10+"px")}},e.ScreenSpaceEventType.MOUSE_MOVE)},t.prototype.addPolygon=function(t){var o=!1;if(t){var i=this.targetDataSource.entities.values;if(0===i.length)return void alert("请先绘制分析范围");for(var n=[],r=0;r<i.length;r++){var a=i[r];if(a.polygon){for(var l=a.polygon.hierarchy._value,s=0;s<l.length;s++){var p=l[s],c=e.Cartographic.fromCartesian(p);n.push(e.Math.toDegrees(c.longitude)),n.push(e.Math.toDegrees(c.latitude)),n.push(t)}a.polygon.material=e.Color.fromRandom({alpha:.01})}}this.targetDataSource.entities.removeAll(),this.targetDataSource.entities.add({name:"未命名面",id:"impolygon",polygon:{hierarchy:e.Cartesian3.fromDegreesArrayHeights(n),material:new e.Color(.5,1,1,.7),fill:!0,perPositionHeight:!0}}),o=!0}else this.PolygonPointArray_fill.length>=9?(this.targetDataSource.entities.add({name:"未命名面",id:"impolygon",polygon:{hierarchy:e.Cartesian3.fromDegreesArrayHeights(this.PolygonPointArray_fill),material:new e.Color(.5,1,1,.7),fill:!0,outline:!0,outlineWidth:100,outlineColor:e.Color.YELLOW,perPositionHeight:!0}}),this.tempDataSource.entities.removeAll(),o=!0):alert("绘制范围最少3个点");return this.viewer.scene.requestRender(),o},t.prototype.remove=function(){this.handlerPolygon.destroy(),this.tempDataSource.entities.removeAll(),this.targetDataSource.entities.removeAll(),this.viewer.scene.requestRender()},t.prototype.createLabel=function(){if(!document.getElementById("trackLabel")){var e=document.createElement("div");e.id="trackLabel",e.style.position="absolute",e.style.top="-40px",e.style.left="-40px",e.style.padding="0 5px",e.style.height="30px",e.style.top="-40px",e.style.textAlign="center",e.style.color="#fff",e.style.backgroundColor="rgba(0, 0, 0, .7)",e.style.display="block",e.style.zIndex="10000",e.style.verticalAlign="middle",e.innerHTML="左击绘制分析范围，右击结束",this.viewer.container.appendChild(e)}},t.prototype.createPolygon=function(t){if(t||!(!t.ranges.length>2))return new e.PolygonGeometry({polygonHierarchy:new e.PolygonHierarchy(e.Cartesian3.fromDegreesArrayHeights(t.ranges)),perPositionHeight:!0});new Error("parameter error")},t});