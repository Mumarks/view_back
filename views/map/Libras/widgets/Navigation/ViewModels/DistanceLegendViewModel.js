define(["Libras","../../../widgets/Navigation/Core/loadView"],function(e,i){"use strict";var t=e.defined,a=e.DeveloperError,n=e.EllipsoidGeodesic,d=e.Cartesian2,r=e.getTimestamp,s=e.EventHelper,o=e.knockout,c=function(e){if(!t(e)||!t(e.terria))throw new a("options.terria is required.");this.terria=e.terria,this._removeSubscription=void 0,this._lastLegendUpdate=void 0,this.eventHelper=new s,this.distanceLabel=void 0,this.barWidth=void 0,this.enableDistanceLegend=!t(e.enableDistanceLegend)||e.enableDistanceLegend,o.track(this,["distanceLabel","barWidth"]),this.eventHelper.add(this.terria.afterWidgetChanged,function(){t(this._removeSubscription)&&(this._removeSubscription(),this._removeSubscription=void 0)},this),this.terria.beforeWidgetChanged.addEventListener(function(){t(this._removeSubscription)&&(this._removeSubscription(),this._removeSubscription=void 0)},this);var i=this;function n(){if(t(i.terria)){var e=i.terria.scene;i._removeSubscription=e.postRender.addEventListener(function(){!function(e,i){if(!e.enableDistanceLegend)return e.barWidth=void 0,void(e.distanceLabel=void 0);var a=r();if(a<e._lastLegendUpdate+250)return;e._lastLegendUpdate=a;var n=i.canvas.clientWidth,s=i.canvas.clientHeight,o=i.camera.getPickRay(new d(n/2|0,s-1)),c=i.camera.getPickRay(new d(1+n/2|0,s-1)),h=i.globe,b=h.pick(o,i),f=h.pick(c,i);if(!t(b)||!t(f))return e.barWidth=void 0,void(e.distanceLabel=void 0);var g=h.ellipsoid.cartesianToCartographic(b),p=h.ellipsoid.cartesianToCartographic(f);l.setEndPoints(g,p);for(var u,L=l.surfaceDistance,m=v.length-1;!t(u)&&m>=0;--m)v[m]/L<100&&(u=v[m]);if(t(u)){var W;W=u>=1e3?(u/1e3).toString()+" km":u.toString()+" m",e.barWidth=u/L|0,e.distanceLabel=W}else e.barWidth=void 0,e.distanceLabel=void 0}(this,e)},i)}else if(t(i.terria.leaflet)){var a=i.terria.leaflet.map,n=function(){h(i,a)};i._removeSubscription=function(){a.off("zoomend",n),a.off("moveend",n)},a.on("zoomend",n),a.on("moveend",n),h(i,a)}}n(),this.eventHelper.add(this.terria.afterWidgetChanged,function(){n()},this),this.terria.afterWidgetChanged.addEventListener(function(){n()},this)};c.prototype.destroy=function(){this.eventHelper.removeAll()},c.prototype.show=function(e){var t;t=this.enableDistanceLegend?'<div class="distance-legend" data-bind="visible: distanceLabel && barWidth"><div class="distance-legend-label" data-bind="text: distanceLabel"></div><div class="distance-legend-scale-bar" data-bind="style: { width: barWidth + \'px\', left: (5 + (125 - barWidth) / 2) + \'px\' }"></div></div>':'<div class="distance-legend"  style="display: none;" data-bind="visible: distanceLabel && barWidth"><div class="distance-legend-label"  data-bind="text: distanceLabel"></div><div class="distance-legend-scale-bar"  data-bind="style: { width: barWidth + \'px\', left: (5 + (125 - barWidth) / 2) + \'px\' }"></div></div>',i(t,e,this)},c.create=function(e){var i=new c(e);return i.show(e.container),i};var l=new n,v=[1,2,3,5,10,20,30,50,100,200,300,500,1e3,2e3,3e3,5e3,1e4,2e4,3e4,5e4,1e5,2e5,3e5,5e5,1e6,2e6,3e6,5e6,1e7,2e7,3e7,5e7];function h(e,i){var t=i.getSize().y/2,a=i.containerPointToLatLng([0,t]).distanceTo(i.containerPointToLatLng([100,t])),n=leaflet.control.scale()._getRoundNum(a),d=n<1e3?n+" m":n/1e3+" km";e.barWidth=n/a*100,e.distanceLabel=d}return c});