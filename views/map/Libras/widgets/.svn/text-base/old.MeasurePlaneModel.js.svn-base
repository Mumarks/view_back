define(["Libras"],function(e){var t=e.ScreenSpaceEventHandler,i=e.ScreenSpaceEventType,s=e.defined,n=e.Cartographic,r=e.Cartesian2,o=e.Cartesian3,a=e.Math,h=e.GeometryInstance,c=e.CorridorGeometry,p=e.VertexFormat,l=e.ColorGeometryInstanceAttribute,m=e.PerInstanceColorAppearance,d=e.ClassificationType,y=e.GroundPrimitive,P=e.Color,g=e.CircleGeometry,u=e.EllipsoidGeodesic,f=e.sampleTerrainMostDetailed,v=e.when;return{startMeasure:function(e,t,i){this.type=t,this.viewer=e,this.camera=e.camera,this.scene=e.scene,this.ellipsoid=this.scene.globe.ellipsoid,this.geoId=Date.now(),this.handler=null,this.keyPoints=[],this.screenPoints=[],this.primiGeo=null,this.successCallBack=i,this.EventDriv("left_click",this.positionPick)},EventDriv:function(e,s){var n=this;(this.handler=new t(this.scene.canvas)).setInputAction(function(e){s.call(n,e)},i[e.toUpperCase()])},positionPick:function(e){if(this.screenPoints.push(e.position.clone()),this.scene.pickPositionSupported){if("3d"==this.type)var t=this.scene.pickPosition(e.position);else t=this.camera.pickEllipsoid(e.position);if(s(t)){var i=n.fromCartesian(t),r=a.toDegrees(i.longitude),o=a.toDegrees(i.latitude);4==this.keyPoints.length&&(this.keyPoints=[]),this.keyPoints.push(r,o),this.pointsCountChange()}}},pointsCountChange:function(){if(this.firstPoint&&this.viewer.scene.primitives.remove(this.firstPoint),"3d"==this.type)switch(this.keyPoints.length){case 2:this.primiGeo&&this.primiGeo.destroy(),startCartogra=n.fromDegrees(this.keyPoints[0],this.keyPoints[1]),this.startCartogra=startCartogra,this.firstPoint=this.scene.primitives.add(new y({geometryInstances:new h({geometry:new g({center:o.fromDegrees(this.keyPoints[0],this.keyPoints[1]),radius:2}),attributes:{color:l.fromColor(new P(1,0,0,.8))}}),appearance:new m({translucent:!1,closed:!0}),classificationType:d.BOTH}));break;case 4:endCartogra=n.fromDegrees(this.keyPoints[2],this.keyPoints[3]),this.endCartogra=endCartogra,this.primiGeo&&this.primiGeo.destroy(),this.primiGeo=this.scene.primitives.add(new y({geometryInstances:new h({geometry:new c({vertexFormat:p.POSITION_ONLY,positions:o.fromDegreesArray(this.keyPoints),width:2}),attributes:{color:l.fromColor(new P(1,0,0,.8))}}),appearance:new m({translucent:!1,closed:!0}),classificationType:d.BOTH})),this.computed()}else switch(this.keyPoints.length){case 2:return startCartogra=n.fromDegrees(this.keyPoints[0],this.keyPoints[1]),this.startCartogra=startCartogra,this.entity&&this.viewer.entities.remove(this.entity),void(this.entity=this.viewer.entities.add({position:o.fromDegrees(this.keyPoints[this.keyPoints.length-2],this.keyPoints[this.keyPoints.length-1]),point:{pixelSize:10,disableDepthTestDistance:1e4}}));case 4:return endCartogra=n.fromDegrees(this.keyPoints[2],this.keyPoints[3]),this.endCartogra=endCartogra,this.entity&&this.viewer.entities.remove(this.entity),this.entity=this.viewer.entities.add({polyline:{positions:o.fromDegreesArray(this.keyPoints),width:2,disableDepthTestDistance:1e4}}),void this.computed()}},computed:function(){var e=new u,t=this.keyPoints;e.setEndPoints(this.startCartogra,this.endCartogra);var i=e.surfaceDistance,s=(Math.min(t[0],t[2]),Math.max(t[0],t[2]),Math.min(t[1],t[3])),o=(Math.max(t[1],t[3]),i/50);if("3d"==this.type){var a=this.scene.pickPosition(this.screenPoints[0]),h=this.scene.pickPosition(this.screenPoints[1]);n.fromCartesian(a),n.fromCartesian(h)}else a=this.camera.pickEllipsoid(this.screenPoints[0]),h=this.camera.pickEllipsoid(this.screenPoints[1]),n.fromCartesian(a),n.fromCartesian(h);for(var c=[],p=Math.min(this.screenPoints[0].x,this.screenPoints[1].x),l=Math.max(this.screenPoints[0].x,this.screenPoints[1].x),m=Math.min(this.screenPoints[0].y,this.screenPoints[1].y),d=(l-p)/50,y=(Math.max(this.screenPoints[0].y,this.screenPoints[1].y)-m)/50,P=p,g=m,k=0,C=[],w=[],D=0;D<50;P+=d,g+=y,k+=o,D++){if(this.type="3d")var G=this.scene.pickPosition(new r(P,g));else G=this.camera.pickEllipsoid(new r(P,g));cartographic=n.fromCartesian(G),C.push(cartographic),cartographic.height&&c.push([Math.round(k)+"m",cartographic.height.toFixed(2)])}this.keyPoints=[],this.screenPoints=[];var x=this;"3d"!=this.type?v(f(this.viewer.terrainProvider,C),function(e){for(var t=0;t<e.length;++t)e[t].height+=10,w.push([c[t][0],0|e[t].height]);x.successCallBack(w)}).otherwise(function(e){for(var t=0;t<c.length;++t)w.push([c[t][0],0]);x.successCallBack(w)}):x.successCallBack(c)},clear:function(e){this.entity&&this.viewer.entities.remove(this.entity),this.primiGeo&&this.viewer.scene.primitives.remove(this.primiGeo),this.firstPoint&&this.viewer.scene.primitives.remove(this.firstPoint),this.viewer.scene.requestRender(),this.handler&&this.handler.removeInputAction("LEFT_CLICK"),this.handler&&this.handler.destroy(),this.handler=null,this.keyPoints=[],this.screenPoints=[],this.primiGeo=null,this.entity=null,e&&e()}}});