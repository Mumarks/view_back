define(["Libras"],function(t){"use strict";var i=t.ScreenSpaceEventType,e=t.ScreenSpaceEventHandler,s=t.ClassificationType,n=(t.BoundingSphere,t.Cartesian2,t.Cartesian3),o=t.Color,h=(t.ComponentDatatype,t.defineProperties),l=(t.Geometry,t.GeometryAttribute,t.GeometryInstance,t.PrimitiveType,t.CallbackProperty),p=t.PolylineGlowMaterialProperty,a=(t.Appearance,t.BlendingState,t.LabelStyle),r=t.HorizontalOrigin,g=(t.Primitive,t.VerticalOrigin);function T(t,s){this.viewer=t,this.type=s,this.scene=t.scene,this._enable=!1,this.enable=!0,this.points=[],this.poinsTemp=[],this.startDraw=!1,this.leftpoints=[],this.labelTmp=[],this.pixelPoints=[],this.lengthLabeltotalTemp=this.viewer.entities.add({label:{show:!1,showBackground:!0,font:"34px KaiTi",fillColor:o.WHITE,outlineColor:o.BACK,outlineWidth:5,style:a.FILL_AND_OUTLINE,horizontalOrigin:r.CENTER,verticalOrigin:g.BASELINE,disableDepthTestDistance:1e4,scale:.5}}),this.lengthLabelsingleTemp=this.viewer.entities.add({label:{show:!1,showBackground:!0,font:"36px KaiTi",fillColor:o.WHITE,outlineColor:o.BACK,outlineWidth:5,style:a.FILL_AND_OUTLINE,horizontalOrigin:r.CENTER,verticalOrigin:g.BASELINE,disableDepthTestDistance:1e4,scale:.5}}),this.viewer.scene.requestRenderMode=!1;var n=this;T.prototype.getPoint3D=function(){return n.poinsTemp},T.prototype.getPoint3DTemp=function(){return n.leftpoints},T.prototype.getEndPoint3D=function(){if(2==n.poinsTemp.length)return n.poinsTemp[1].clone()},this.line=t.entities.add({name:"Orange line with black outline at height and following the surface",polyline:{positions:new l(this.getPoint3D,!1),width:5,material:new p({glowPower:.2,color:o.YELLOW})}}),this.lineTemp=t.entities.add({name:"Orange line with black outline at height and following the surface",polyline:{positions:new l(this.getPoint3DTemp,!1),width:5,material:new p({glowPower:.2,color:o.GREENYELLOW})}}),this.endPixelPoint=t.entities.add({name:"",position:new l(this.getEndPoint3D,!1),point:{pixelSize:5,color:o.RED,disableDepthTestDistance:1e4}});var h=this.handler=new e(this.scene.canvas),c=(n=this,void 0);h.setInputAction(function(t){c=t.position},i.LEFT_DOWN),h.setInputAction(function(t){if(t&&t.position){var i=Math.abs(c.x-t.position.x),e=Math.abs(c.y-t.position.y);i>3||e>3?c=void 0:n.addPoint3D(t)}},i.LEFT_UP),h.setInputAction(function(t){n&&n.enable&&n.addPointTemp(t)},i.MOUSE_MOVE),h.setInputAction(function(t){n&&n.enable&&n.finish(t)},i.RIGHT_CLICK)}return h(T.prototype,{enable:{get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t)}}}),T.prototype.addPoint3D=function(t){if(this._enable){if("3d"==this.type)var i=this.scene.pickPosition(t.position);else i=this.viewer.camera.pickEllipsoid(t.position);if(void 0==i&&2==this.poinsTemp.length&&(i=this.poinsTemp[1]),void 0!=i){this.startDraw||(this.points=[]),this.points.push(i,i.clone()),this.leftpoints.push(i),this.poinsTemp=[],this.poinsTemp.push(i),this.startDraw=!0;var e=this.viewer.entities.add({name:"",position:i,point:{pixelSize:5,color:o.RED,classificationType:s.BOTH,disableDepthTestDistance:1e4}});this.pixelPoints.push(e)}if(this.leftpoints.length>1){var h=new n(0,0,0);h.x=(this.leftpoints[this.leftpoints.length-1].x+this.leftpoints[this.leftpoints.length-2].x)/2,h.y=(this.leftpoints[this.leftpoints.length-1].y+this.leftpoints[this.leftpoints.length-2].y)/2,h.z=(this.leftpoints[this.leftpoints.length-1].z+this.leftpoints[this.leftpoints.length-2].z)/2;var l=n.distance(this.points[this.points.length-1],this.points[this.points.length-4]),p=this.viewer.entities.add({label:{show:!0,showBackground:!0,font:"36px KaiTi",fillColor:o.WHITE,outlineColor:o.BACK,outlineWidth:5,style:a.FILL_AND_OUTLINE,classificationType:s.BOTH,horizontalOrigin:r.CENTER,verticalOrigin:g.BASELINE,disableDepthTestDistance:1e4,scale:.5}});p.position=h,p.label.text=l.toFixed(2)+"米",this.labelTmp.push(p)}}},T.prototype.addPointTemp=function(t){if(this._enable&&this.startDraw){var i=this.scene.pickPosition(t.endPosition);if(void 0!=i&&(void 0!=i&&(1==this.poinsTemp.length?this.poinsTemp.push(i):2==this.poinsTemp.length&&(this.poinsTemp[1]=i)),void 0!=i&&this.startDraw)){this.points[this.points.length-1]=i;for(var e=0,s=1;s<this.points.length;s++){var o=this.points[s-1],h=this.points[s];e+=n.distance(o,h)}console.log(this.points);var l=n.distance(this.points[this.points.length-2],this.points[this.points.length-1]),p=[],a=this.scene.pickPosition(t.endPosition);a.x=(this.points[this.points.length-1].x+this.points[this.points.length-2].x)/2,a.y=(this.points[this.points.length-1].y+this.points[this.points.length-2].y)/2,a.z=(this.points[this.points.length-1].z+this.points[this.points.length-2].z)/2,p.push(a),this.lengthLabelsingleTemp.position=p[0],this.lengthLabelsingleTemp.show=!0,this.lengthLabelsingleTemp.label.show=!0,this.lengthLabelsingleTemp.label.text=l.toFixed(2)+"米",this.lengthLabeltotalTemp.position=this.points[0],this.lengthLabeltotalTemp.show=!0,this.lengthLabeltotalTemp.label.show=!0,this.lengthLabeltotalTemp.label.text="总长:"+e.toFixed(2)+"米",this.line.show=!0,this.lineTemp.show=!0,this.endPixelPoint.show=!0}}},T.prototype.finish=function(t){if(this._enable){if(1==this.leftpoints.length){this.startDraw=!1,this.points=[],this.poinsTemp=[],this.leftpoints=[],this.lengthLabelsingleTemp.show=!1,this.lengthLabeltotalTemp.show=!1,this.line.show=!1,this.lineTemp.show=!1;for(var i=0;i<this.labelTmp.length;i++){var e=this.labelTmp[i];void 0!=e&&this.viewer.entities.remove(e)}this.labelTmp=[];for(i=0;i<this.pixelPoints.length;i++){var s=this.pixelPoints[i];void 0!=s&&this.viewer.entities.remove(s)}this.pixelPoints=[],this._enable=!1}if(this.leftpoints.length>1){var o=0;for(i=1;i<this.leftpoints.length;i++){var h=this.leftpoints[i-1],l=this.leftpoints[i];o+=n.distance(h,l)}this.lengthLabeltotalTemp.position=this.points[0],this.lengthLabeltotalTemp.show=!0,this.lengthLabeltotalTemp.label.show=!0,this.lengthLabeltotalTemp.label.text="总长:"+o.toFixed(2)+"米",this.points=[],this.poinsTemp=[],this.lengthLabelsingleTemp.show=!1,this.endPixelPoint.show=!1,this._enable=!1,this.startDraw=!1}}},T.prototype.clear=function(){this.points=[],this.poinsTemp=[],this.leftpoints=[],this.lengthLabelsingleTemp.show=!1,this.lengthLabeltotalTemp.show=!1,this.line.show=!1,this.lineTemp.show=!1;for(var t=0;t<this.labelTmp.length;t++){var i=this.labelTmp[t];void 0!=i&&this.viewer.entities.remove(i)}this.labelTmp=[];for(t=0;t<this.pixelPoints.length;t++){var e=this.pixelPoints[t];void 0!=e&&this.viewer.entities.remove(e)}this.pixelPoints=[],this._enable=!1,this.startDraw=!1},T});