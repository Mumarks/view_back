define(["Libras"],function(t){"use strict";t.BoundingSphere,t.Cartesian2;var i=t.Cartesian3,e=t.Color,s=(t.ComponentDatatype,t.defineProperties),n=(t.Geometry,t.GeometryAttribute,t.PolygonGeometry),o=t.PolygonHierarchy,h=(t.PrimitiveType,t.CallbackProperty),p=(t.PolylineGlowMaterialProperty,t.Appearance,t.BlendingState,t.HorizontalOrigin),l=t.LabelStyle,r=(t.Primitive,t.ScreenSpaceEventHandler),a=t.ScreenSpaceEventType,d=t.VerticalOrigin;function f(t,i){this.type=i,this.viewer=t,this.scene=t.scene,this._enable=!1,this.enable=!0,this.startDraw=!1,this._bAddTemp=!0,this.leftpoints=[],this.poinsTemp=[],this.pointsCompare=[],this.pixelPoints=[],this.AreaLabel=this.viewer.entities.add({label:{show:!0,showBackground:!0,font:"36px KaiTi",fillColor:e.WHITE,outlineColor:e.BACK,outlineWidth:5,style:l.FILL_AND_OUTLINE,horizontalOrigin:p.CENTER,verticalOrigin:d.BASELINE,disableDepthTestDistance:1e4,scale:.5}}),this.PolygonEntity=this.viewer.entities.add({polygon:{material:new e(.5,1,1,.7),outline:!0,outlineColor:e.YELLOW,outlineWidth:1}});var s=this.handler=new r(this.scene.canvas),n=this,o=void 0;s.setInputAction(function(t){o=t.position},a.LEFT_DOWN),s.setInputAction(function(t){if(t&&t.position){var i=Math.abs(o.x-t.position.x),e=Math.abs(o.y-t.position.y);i>3||e>3?o=void 0:n.addPoint3D(t)}},a.LEFT_UP),s.setInputAction(function(t){n&&n.enable&&n.addPointTemp(t)},a.MOUSE_MOVE),s.setInputAction(function(t){n&&n.enable&&n.finish(t)},a.RIGHT_CLICK),f.prototype.getPoint3D=function(){return n.leftpoints},f.prototype.getPoint3DTemp=function(){if(!(n.poinsTemp.length<2))return n.poinsTemp},this.PolygonEntity.polygon.hierarchy=new h(this.getPoint3D,!1),f.prototype.getEndPoint3D=function(){if(n.leftpoints.length>0)return n.leftpoints[n.leftpoints.length-1].clone()},this.endPixelPoint=this.viewer.entities.add({name:"",position:new h(this.getEndPoint3D,!1),point:{pixelSize:5,color:e.RED,disableDepthTestDistance:1e4}}),this.lineTemp=this.viewer.entities.add({name:"",polyline:{positions:new h(this.getPoint3DTemp,!1),width:1}})}return s(f.prototype,{enable:{get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t)}}}),f.prototype.addPoint3D=function(t){if(this._enable){if("3d"==this.type){var i=this.scene.pickPosition(t.position);this.PolygonEntity.perPositionHeight=!0}else{i=this.viewer.camera.pickEllipsoid(t.position);this.PolygonEntity.perPositionHeight=1}if(this.startDraw&&void 0==i&&this.leftpoints.length>0&&(i=this.leftpoints[this.leftpoints.length-1].clone(),0==this.pointsCompare.length&&this.pointsCompare.push(i),1==this.pointsCompare.length&&(this.pointsCompare.pop(),this.pointsCompare.push(i))),void 0!=i){this.startDraw||(this.pointsTemp=[],this.lineTemp.show=!0,this.leftpoints.push(i),this.poinsTemp.push(i),this.endPixelPoint.show=!0),this.startDraw=!0,this._bAddTemp=!0;var s=this.viewer.entities.add({name:"",position:i,point:{pixelSize:5,color:e.RED,disableDepthTestDistance:1e4}});this.pixelPoints.push(s)}this.leftpoints.length>2&&(this.lineTemp.show=!1,this.computeArea())}},f.prototype.addPointTemp=function(t){if(this._enable&&this.startDraw){if("3d"==this.type)var i=this.scene.pickPosition(t.endPosition);else i=this.viewer.camera.pickEllipsoid(t.endPosition);void 0!=i&&(this._bAddTemp&&(this.leftpoints.push(i),this._bAddTemp=!1),1==this.poinsTemp.length?this.poinsTemp.push(i):2==this.poinsTemp.length&&(this.poinsTemp[1]=i),void 0!=i&&this.startDraw&&(this.leftpoints[this.leftpoints.length-1]=i,this.leftpoints.length>2&&this.computeArea()))}},f.prototype.computeArea=function(){var t=new n({polygonHierarchy:new o(this.leftpoints),perPositionHeight:!0}),e=n.createGeometry(t);if(void 0!=e){for(var s=e.indices,h=e.attributes.position.values,p=[],l=0,r=0;r<h.length/3;r++){var a=new i(0,0,0);a.x=h[3*r],a.y=h[3*r+1],a.z=h[3*r+2],p.push(a)}for(r=0;r<s.length/3;r++){var d=[];d.push(p[s[3*r]],p[s[3*r+1]],p[s[3*r+2]]);var f=i.distance(d[0],d[1]),c=i.distance(d[0],d[2]),y=i.distance(d[1],d[2]),g=(f+c+y)/2;l+=Math.sqrt(g*(g-f)*(g-y)*(g-c))}var m=0,P=0,u=0;for(r=0;r<this.leftpoints.length;r++)m+=this.leftpoints[r].x,P+=this.leftpoints[r].y,u+=this.leftpoints[r].z;var v=new i(0,0,0);v.x=m/this.leftpoints.length,v.y=P/this.leftpoints.length,v.z=u/this.leftpoints.length,this.PolygonEntity.show=!0,this.AreaLabel.position=v,this.AreaLabel.label.show=!0,this.AreaLabel.label.text="面积:"+l.toFixed(2)+"平方米"}},f.prototype.finish=function(t){this.leftpoints.length<3&&this.clear(),void 0!==this.pointsCompare[0]&&void 0!==this.leftpoints[this.leftpoints.length-1]&&(this.pointsCompare[0].x==this.leftpoints[this.leftpoints.length-1].x&&this.pointsCompare[0].y==this.leftpoints[this.leftpoints.length-1].y&&this.pointsCompare[0].z==this.leftpoints[this.leftpoints.length-1].z||this.leftpoints.pop()),this._enable=!1,this.startDraw=!1,this._bAddTemp=!0,this.endPixelPoint.show=!1,this.endPixelPoint.show=!1},f.prototype.clear=function(){this.leftpoints=[],this.poinsTemp=[],this.PolygonEntity.show=!1,this.AreaLabel.label.show=!1,this._enable=!1,this.startDraw=!1,this._bAddTemp=!0;for(var t=0;t<this.pixelPoints.length;t++){var i=this.pixelPoints[t];void 0!=i&&this.viewer.entities.remove(i)}this.pixelPoints=[],this.endPixelPoint.show=!1,this.viewer.entities.remove(this.PolygonEntity),this.viewer.entities.remove(this.AreaLabel),this.viewer.entities.remove(this.endPixelPoint)},f});