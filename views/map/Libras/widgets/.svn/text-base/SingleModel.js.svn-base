define(["Libras"],function(e){var t=e.ColorGeometryInstanceAttribute,i=e.Color,n=e.PerInstanceColorAppearance,o=e.ClassificationType,r=e.ScreenSpaceEventHandler,s=e.GeometryInstance,a=e.ScreenSpaceEventType,h=e.Cartesian3,c=e.PolygonHierarchy,l=e.GroundPrimitive,p=e.PolygonGeometry,m=e.VertexFormat,d=e.CircleGeometry,g=e.CorridorGeometry,u=e.Math,y=e.Cartographic,v=e.defined;return{startModel:function(t,i){this.camera=t.camera,this.scene=t.scene,this.ellipsoid=this.scene.globe.ellipsoid,this.geoId=Date.now(),this.handler=null,this.keyPoints=[],this.primiGeo=null,this.EventDriv("left_click",this.positionPick),this.HeightLightHandler&&this.HeightLightHandler.removeInputAction(e.ScreenSpaceEventType.LEFT_CLICK),this.removeHeightLightEvent()},endGeometry:function(){var e=this.handler;e&&e.destroy(),this.handler=null},setColorAndAlpha:function(e){var n=this.primiGeo;n&&(n.getGeometryInstanceAttributes(this.geoId).color=t.toValue(i.fromCssColorString(e.color).withAlpha(e.alpha)))},setGeoAttr:function(e,t,i){if(console.log(!this.primiGeo),this.primiGeo){var n=this.handler;n&&n.destroy()&&(this.handler=null),e&&this.primiGeo&&(this.primiGeo.getGeometryInstanceAttributes(this.geoId).geoAttr=e);var o=this.primiGeo.getGeometryInstanceAttributes(this.geoId).color;o[3]=1,this.primiGeo.getGeometryInstanceAttributes(this.geoId).color=o,this.addHeightLightEvent(),e.keyPoints=this.keyPoints,t(e,this.primiGeo)}else i()},cancleModel:function(){this.handler.removeInputAction(e.ScreenSpaceEventType.LEFT_CLICK),this.primiGeo.destroy(),this.keyPoints=[]},EventDriv:function(e,t){var i=this;(this.handler=new r(this.scene.canvas)).setInputAction(function(e){t.call(i,e)},a[e.toUpperCase()])},positionPick:function(e){if(this.scene.pickPositionSupported){var t=this.scene.pickPosition(e.position);if(v(t)){var i=y.fromCartesian(t),n=u.toDegrees(i.longitude),o=u.toDegrees(i.latitude);this.keyPoints.push(n,o),this.pointsCountChange()}}},pointsCountChange:function(){switch(this.keyPoints.length){case 2:this.primiGeo=this.scene.primitives.add(new l({geometryInstances:new s({geometry:new d({center:h.fromDegrees(this.keyPoints[0],this.keyPoints[1]),radius:1}),attributes:{color:t.fromColor(new i(1,0,0,.8))},id:this.geoId}),appearance:new n({translucent:!1,closed:!0}),classificationType:o.LIBRAS_3D_TILE}));break;case 4:this.primiGeo.destroy(),this.primiGeo=this.scene.primitives.add(new l({geometryInstances:new s({geometry:new g({vertexFormat:m.POSITION_ONLY,positions:h.fromDegreesArray(this.keyPoints),width:1}),attributes:{color:t.fromColor(new i(1,0,0,.8))},id:this.geoId}),appearance:new n({translucent:!1,closed:!0}),classificationType:o.LIBRAS_3D_TILE}));break;default:this.primiGeo.destroy(),this.primiGeo=this.scene.primitives.add(new l({geometryInstances:new s({geometry:new p({polygonHierarchy:new c(h.fromDegreesArray(this.keyPoints))}),attributes:{color:t.fromColor(new i(1,0,0,.8))},id:this.geoId}),appearance:new n({translucent:!1,closed:!0}),classificationType:o.LIBRAS_3D_TILE}))}},showGeometry:function(e,t){this.camera=e.camera,this.scene=e.scene,this.ellipsoid=this.scene.globe.ellipsoid,this.geoId=Date.now(),this.handler=null,this.keyPoints=[],this.primiGeo=null;var i=this.HeightLightHandler=new r(e.scene.canvas);this.addHeightLightEvent(),i.setInputAction(function(i){var n=e.scene.pick(i.position);if(n){if(n.id)var o=n.primitive.getGeometryInstanceAttributes(n.id).geoAttr;else o=n;t(o)}},a.LEFT_CLICK)},addHeightLightEvent:function(){var e=this;e.HeightLightHandler&&e.HeightLightHandler.setInputAction(function(t){e.enterHeightLight.call(e,t)},a.MOUSE_MOVE)},removeHeightLightEvent:function(){this.HeightLightHandler&&this.HeightLightHandler.removeInputAction(a.MOUSE_MOVE)},enterHeightLight:function(e){var t=this.scene.pick(e.endPosition);if(t&&t.id){if(this.actionGeometry==t)return;if(this.pickedFeature){var i=this.pickedFeature.primitive.getGeometryInstanceAttributes(this.pickedFeature.id).color;i[3]=1,this.pickedFeature.primitive.getGeometryInstanceAttributes(this.pickedFeature.id).color=i}if(this.actionGeometry=t,!t.primitive.getGeometryInstanceAttributes)return;let e=t.primitive.getGeometryInstanceAttributes(t.id).geoAttr,n=t.primitive.getGeometryInstanceAttributes(t.id).color;e&&e.alpha&&(n[3]=225*e.alpha)||(n[3]=180),t.primitive.getGeometryInstanceAttributes(t.id).color=n}else{if(!this.actionGeometry||!this.actionGeometry.primitive.getGeometryInstanceAttributes)return;let e=this.actionGeometry.primitive.getGeometryInstanceAttributes(this.actionGeometry.id).color;e[3]=1,this.actionGeometry.primitive.getGeometryInstanceAttributes(this.actionGeometry.id).color=e,this.actionGeometry=null}}}});