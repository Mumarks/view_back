define(["Libras"],function(t){"use strict";t.BoundingSphere,t.Cartesian2;var e=t.Cartesian3,i=t.Cartographic,s=t.Color,n=(t.ComponentDatatype,t.defineProperties),o=(t.Geometry,t.GeometryInstance,t.Math),r=(t.PrimitiveType,t.Appearance,t.BlendingState,t.HorizontalOrigin),a=t.LabelStyle,l=t.ScreenSpaceEventHandler,h=t.ScreenSpaceEventType,d=(t.Primitive,t.VerticalOrigin),p=t.CallbackProperty,u=t.PolylineGlowMaterialProperty,c=t.PolylineOutlineMaterialProperty;function g(n){var D=n.viewer;this.viewer=D,this.scene=D.scene,this._enable=!1,this.enable=!0,this.startDraw=!1,this.startPoint=new e(0,0,0),this.endPoint=new e(0,0,0),this.eMeasureStatus=!1;var f=this;g.prototype.getStartPoint3D=function(){return f.startPoint},g.prototype.getEndPoint3D=function(){return f.endPoint},g.prototype.getMidPoint3D=function(){if(3==f.eMeasureStatus||2==f.eMeasureStatus){var t=i.fromCartesian(f.startPoint),s=i.fromCartesian(f.endPoint);if(void 0!=t&&void 0!=s){if(s.height>t.height){var n=o.toDegrees(t.longitude),r=o.toDegrees(t.latitude);return e.fromDegrees(n,r,s.height)}n=o.toDegrees(s.longitude),r=o.toDegrees(s.latitude);return e.fromDegrees(n,r,t.height)}}},g.prototype.getPoint3D=function(){var t=[];if(3==f.eMeasureStatus||2==f.eMeasureStatus){var s=i.fromCartesian(f.startPoint),n=i.fromCartesian(f.endPoint);if(void 0!=s&&void 0!=n)if(n.height>s.height){var r=o.toDegrees(s.longitude),a=o.toDegrees(s.latitude);t.push(f.startPoint,e.fromDegrees(r,a,n.height),f.endPoint,f.startPoint)}else{r=o.toDegrees(n.longitude),a=o.toDegrees(n.latitude);t.push(f.startPoint,e.fromDegrees(r,a,s.height),f.endPoint,f.startPoint)}}return t},this.startEllipsoid=D.entities.add({name:"",position:new p(this.getStartPoint3D,!1),point:{pixelSize:5,color:s.RED,disableDepthTestDistance:1e4}}),this.endEllipsoid=D.entities.add({name:"",position:new p(this.getEndPoint3D,!1),point:{pixelSize:5,color:s.RED,disableDepthTestDistance:1e4}}),this.midEllipsoid=D.entities.add({name:"",position:new p(this.getMidPoint3D,!1),point:{pixelSize:5,color:s.RED,disableDepthTestDistance:1e4}}),this.triangleLine=D.entities.add({name:"",polyline:{positions:new p(this.getPoint3D,!1),followSurface:!1,width:3,material:new u({glowPower:.5,color:s.YELLOW}),depthFailMaterial:new c({color:s.RED,outlineWidth:2,outlineColor:s.BLACK})}}),this.entity00=D.entities.add({label:{show:!0,showBackground:!0,font:"30px Helvetica",fillColor:s.WHITE,outlineColor:s.BACK,outlineWidth:5,pixelOffset:new t.Cartesian2(30,30),style:a.FILL_AND_OUTLINE,horizontalOrigin:r.CENTER,verticalOrigin:d.BASELINE,disableDepthTestDistance:1e4,scale:.5}}),this.entity0=D.entities.add({label:{show:!0,showBackground:!0,font:"30px Helvetica",fillColor:s.WHITE,outlineColor:s.BACK,outlineWidth:5,pixelOffset:new t.Cartesian2(-30,-30),style:a.FILL_AND_OUTLINE,horizontalOrigin:r.CENTER,verticalOrigin:d.BASELINE,disableDepthTestDistance:1e4,scale:.5}}),this.entity1=D.entities.add({label:{show:!0,showBackground:!0,font:"30px Helvetica",fillColor:s.WHITE,outlineColor:s.BACK,outlineWidth:5,style:a.FILL_AND_OUTLINE,horizontalOrigin:r.CENTER,verticalOrigin:d.BASELINE,disableDepthTestDistance:1e4,scale:.5}}),this.entity2=D.entities.add({label:{show:!0,showBackground:!0,font:"30px Helvetica",fillColor:s.WHITE,outlineColor:s.BACK,outlineWidth:5,style:a.FILL_AND_OUTLINE,horizontalOrigin:r.CENTER,verticalOrigin:d.BASELINE,disableDepthTestDistance:1e4,scale:.5}}),this.entity3=D.entities.add({label:{show:!0,showBackground:!0,font:"30px Helvetica",fillColor:s.WHITE,outlineColor:s.BACK,outlineWidth:5,style:a.FILL_AND_OUTLINE,horizontalOrigin:r.CENTER,verticalOrigin:d.BASELINE,disableDepthTestDistance:1e4,scale:.5}});var y=this.handler=new l(this.scene.canvas),v=void 0;y.setInputAction(function(t){v=t.position},h.LEFT_DOWN),y.setInputAction(function(t){var e=Math.abs(v.x-t.position.x),i=Math.abs(v.y-t.position.y);e>3||i>3?v=void 0:f.addPoint3D(t)},h.LEFT_UP),y.setInputAction(function(t){f&&f.enable&&f.addPointTemp(t)},h.MOUSE_MOVE)}return n(g.prototype,{enable:{get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t)}}}),g.prototype.addPoint3D=function(t){if(this._enable&&3!=this.eMeasureStatus){if(0==this.eMeasureStatus){this.eMeasureStatus=1;var e=null;if(this.scene.pick(t.position))e=this.scene.pickPosition(t.position);else{var i=this.scene.camera.getPickRay(t.position);e=this.scene.globe.pick(i,viewer.scene)}if(void 0==e)return;this.startPoint=e}2==this.eMeasureStatus&&(this.eMeasureStatus=3),3==this.eMeasureStatus&&(this.computeDistance(),this._enable=!1)}},g.prototype.addPointTemp=function(t){if(this._enable&&(1==this.eMeasureStatus&&(this.endEllipsoid.show=!0,this.startEllipsoid.show=!0,this.midEllipsoid.show=!0,this.entity1.show=!0,this.entity2.show=!0,this.entity3.show=!0,this.triangleLine.show=!0,this.eMeasureStatus=2),2==this.eMeasureStatus)){var e=null;if(this.scene.pick(t.endPosition))e=this.scene.pickPosition(t.endPosition);else{var i=this.scene.camera.getPickRay(t.endPosition);e=this.scene.globe.pick(i,viewer.scene)}if(void 0==e)return;void 0!=e&&(this.endPoint=e),this.eMeasureStatus=2,this.computeDistance()}},g.prototype.computeDistance=function(){var t=i.fromCartesian(this.endPoint),s=o.toDegrees(t.longitude),n=o.toDegrees(t.latitude),r=t.height,a=i.fromCartesian(this.startPoint),l=o.toDegrees(a.longitude),h=o.toDegrees(a.latitude),d=a.height,p=e.distance(this.startPoint,e.fromDegrees(l,h,r)),u=e.distance(this.endPoint,e.fromDegrees(l,h,r)),c=e.distance(this.startPoint,this.endPoint),g=180*Math.asin(u/c)/Math.PI;r>d?(this.entity00.position=e.fromDegrees(s,n,r),this.entity0.position=e.fromDegrees(l,h,d),this.entity1.position=e.fromDegrees(l,h,(d+r)/2),this.entity2.position=e.fromDegrees((l+s)/2,(h+n)/2,r)):(this.entity1.position=e.fromDegrees(s,n,(d+r)/2),this.entity2.position=e.fromDegrees((l+s)/2,(h+n)/2,d)),this.entity00.label.show=!0,this.entity00.label.text=(90-g).toFixed(2)+" °",this.entity0.label.show=!0,this.entity0.label.text=g.toFixed(2)+" °",this.entity1.label.show=!0,this.entity1.label.text=p.toFixed(2)+" m",this.entity2.label.show=!0,this.entity2.label.text=u.toFixed(2)+" m",this.entity3.position=e.fromDegrees((l+s)/2,(h+n)/2,(r+d)/2),this.entity3.label.show=!0,this.entity3.label.text=c.toFixed(2)+" m"},g.prototype.destroy=function(){this._enable=!1,this.endEllipsoid.show=!1,this.startEllipsoid.show=!1,this.midEllipsoid.show=!1,this.entity1.show=!1,this.entity2.show=!1,this.entity3.show=!1,this.triangleLine.show=!1,this.eMeasureStatus=0,this.viewer.entities.remove(this.endEllipsoid),this.viewer.entities.remove(this.startEllipsoid),this.viewer.entities.remove(this.midEllipsoid),this.viewer.entities.remove(this.entity00),this.viewer.entities.remove(this.entity0),this.viewer.entities.remove(this.entity1),this.viewer.entities.remove(this.entity2),this.viewer.entities.remove(this.entity3),this.viewer.entities.remove(this.triangleLine),this.viewer.scene.requestRender()},g});